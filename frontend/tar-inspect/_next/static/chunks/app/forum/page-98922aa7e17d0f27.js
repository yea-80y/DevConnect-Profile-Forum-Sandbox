(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[300],{63:(e,t,r)=>{"use strict";var a=r(7260);r.o(a,"useRouter")&&r.d(t,{useRouter:function(){return a.useRouter}}),r.o(a,"useSearchParams")&&r.d(t,{useSearchParams:function(){return a.useSearchParams}})},431:(e,t,r)=>{Promise.resolve().then(r.bind(r,5537))},3807:(e,t,r)=>{"use strict";r.d(t,{default:()=>u,y:()=>d});var a=r(5155),n=r(2115),o=r(43),l=r(2983),i=r(6329);let s="woco.owner0x",c=(0,n.createContext)({isAdmin:!1,address:null});function d(){return(0,n.useContext)(c)}function u(e){let{children:t}=e,[r,d]=(0,n.useState)(null),[u,f]=(0,n.useState)(0),[h,p]=(0,n.useState)({isAdmin:!1,address:null}),m=(0,l.A)(),w=(0,n.useMemo)(()=>{if(!m.ready)return null;let e="web3"===m.kind?m.parent:m.safe;return e&&/^0x[0-9a-fA-F]{40}$/.test(e)?e:null},[m.ready,m.kind,m.parent,m.safe]),x="".concat(null!=w?w:"nosub","|").concat(u),y=r&&/^0x[0-9a-fA-F]{40}$/.test(r)?r:null;return(0,n.useEffect)(()=>{try{let e=localStorage.getItem(s);e&&e.startsWith("0x")&&d(t=>null!=t?t:e)}catch(e){}let e=!0;return(async()=>{try{var t,r;let a=await fetch((0,i.apiUrl)("/api/profile"),{cache:"no-store",credentials:"include"}),n=await a.json();if(!e||!(null==n?void 0:n.ok)||!(null==(r=n.owner)||null==(t=r.startsWith)?void 0:t.call(r,"0x")))return;d(e=>e===n.owner?e:n.owner);try{localStorage.setItem(s,n.owner)}catch(e){}}catch(e){}})(),()=>{e=!1}},[]),(0,n.useEffect)(()=>{let e=!0,t=!1,r=async()=>{if(!t&&e){t=!0;try{for(let t of[0,150,400])try{var r;t&&await new Promise(e=>setTimeout(e,t));let a=await fetch((0,i.apiUrl)("/api/auth/me"),{credentials:"include",cache:"no-store",headers:{...w?{"X-Subject-Address":w}:{}}}),n=await a.json().catch(()=>({}));if(!e)return;p({isAdmin:!!(null==n?void 0:n.isAdmin),address:null!=(r=null==n?void 0:n.address)?r:null});return}catch(e){}}finally{t=!1}}};r();let a=()=>r();return window.addEventListener("admin:changed",a),()=>{e=!1,window.removeEventListener("admin:changed",a)}},[w]),(0,n.useEffect)(()=>{let e=()=>f(e=>e+1);return window.addEventListener("profile:updated",e),()=>window.removeEventListener("profile:updated",e)},[]),(0,a.jsx)(c.Provider,{value:h,children:(0,a.jsx)(o.H,{subject:w,feedOwner:y,beeUrl:"https://gateway.woco-net.com",children:t},x)})}},5537:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>O});var a=r(5155),n=r(2619),o=r.n(n),l=r(2115),i=r(63);let s="devconnect_test_board:general";var c=r(2983),d=r(3998);async function u(e){let t=new TextEncoder().encode(e),r=Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",t))).map(e=>e.toString(16).padStart(2,"0")).join("");return"0x".concat(r)}var f=r(8701);async function h(e){let{apiUrl:t}=await Promise.resolve().then(r.bind(r,6329)),a=await fetch(t("/api/forum/board?boardId=".concat(encodeURIComponent(e))),{cache:"no-store"}),n=await a.json();if(!a.ok||!(null==n?void 0:n.ok))throw Error((null==n?void 0:n.error)||"BOARD_FETCH_FAILED");return n}async function p(e,t){let{apiUrl:a}=await Promise.resolve().then(r.bind(r,6329)),n=await fetch(a("/api/forum/thread?boardId=".concat(encodeURIComponent(e),"&threadRef=").concat(t)),{cache:"no-store"}),o=await n.json();if(!n.ok||!(null==o?void 0:o.ok))throw Error((null==o?void 0:o.error)||"THREAD_FETCH_FAILED");return o}async function m(e){let t=e.toLowerCase();{let e=await fetch("".concat(f.b,"/bytes/").concat(t),{cache:"no-store"});if(e.ok){let r=await e.text();try{return JSON.parse(r)}catch(e){throw console.error("[fetchPostJSON] Invalid JSON from /bytes:",r.slice(0,200)),Error("POST_JSON_PARSE_FAILED_BYTES ".concat(t))}}}{let e=await fetch("".concat(f.b,"/bzz/").concat(t),{cache:"no-store"});if(e.ok){let r=await e.text();try{return JSON.parse(r)}catch(e){throw console.error("[fetchPostJSON] Invalid JSON from /bzz:",r.slice(0,200)),Error("POST_JSON_PARSE_FAILED_BZZ ".concat(t))}}}throw Error("FETCH_POST_FAILED ".concat(t))}function w(e){return"object"==typeof e&&null!==e}function x(e){if(!w(e))return;let t=e.error;return"string"==typeof t?t:void 0}async function y(e,t){var a,n,o;let l,{apiUrl:i}=await Promise.resolve().then(r.bind(r,6329)),s=performance.now(),c=await fetch(i("/api/forum/post"),{method:"POST",headers:{"content-type":"application/json",...null!=t?t:{}},body:JSON.stringify(e)}),d=Math.round(performance.now()-s);try{l=await c.json()}catch(e){throw console.warn("[client] /api/forum/post bad JSON ms",d),Error("POST_BAD_JSON")}if(!c.ok){let e=null!=(a=x(l))?a:"POST_FAILED";throw console.warn("[client] /api/forum/post failed ms",d,e),Error(e)}if(!(w(o=l)&&!0===o.ok&&"string"==typeof o.postRef&&"string"==typeof o.threadRef)){let e=null!=(n=x(l))?n:"POST_FAILED";throw console.warn("[client] /api/forum/post malformed ms",d,e),Error(e)}return console.log("[client] /api/forum/post ok ms",d),l}var v=r(43);let g=e=>{if(!e)return null;let t=e.toLowerCase().replace(/^0x/,"").replace(/[^0-9a-f]/g,"");return 64===t.length?t:null};function b(e){let{boardId:t,replyTo:r,onOptimistic:n,onPosted:o}=e,[i,s]=(0,l.useState)(""),[f,h]=(0,l.useState)(!1),[p,m]=(0,l.useState)(null),{profile:w}=(0,v.x)(),x=(0,c.A)();if(!x.ready)return(0,a.jsx)("div",{className:"rounded border p-3 bg-white/90",children:(0,a.jsx)("div",{className:"text-sm",children:"Loading identity…"})});if("web3"===x.kind&&"blocked"===x.postAuth)return(0,a.jsxs)("div",{className:"rounded border p-3 bg-white/90 space-y-2",children:[(0,a.jsx)("div",{className:"text-sm font-semibold",children:"Authorize posting"}),(0,a.jsx)("p",{className:"text-sm",children:"You need to authorize a posting key with your wallet before posting."}),(0,a.jsx)(d.$,{onClick:x.signCapabilityNow,children:"Authorize (EIP-712)"})]});async function b(){if(m(null),!x.safe)return void m("No active posting key. Log in first.");if("web3"===x.kind&&"parent-bound"!==x.postAuth)return void m("Wallet is connected but not authorized to post yet.");if(!i.trim())return void m("Write something first");h(!0);let e=crypto.randomUUID();try{var a;let l=performance.now(),c="web3"===x.kind?x.parent:x.safe;if(!c)return void m("Missing actor address");let d=function(e){var t,r;if(!e||"object"!=typeof e)return null;let a="string"==typeof e.avatarRef?g(e.avatarRef):null,n="string"==typeof e.avatarRefHex?g(e.avatarRefHex):null,o=e.avatar,l=o&&"object"==typeof o&&"string"==typeof o.ref?g(o.ref):null;return null!=(r=null!=(t=null!=a?a:n)?t:l)?r:null}(w),f=await u(i),p={subject:c,boardId:t,threadRef:null!=r?r:void 0,content:i,contentSha256:f,displayName:null!=(a=null==w?void 0:w.name)?a:void 0,avatarRef:null!=d?d:void 0,createdAt:Date.now(),nonce:crypto.getRandomValues(new Uint32Array(4)).join("-"),version:1};null==n||n({clientTag:e,postRef:"local:".concat(e),threadRef:null!=r?r:"local:".concat(e),payload:p});let v=await x.signPost(JSON.stringify(p));if(!/^0x[0-9a-fA-F]+$/.test(v))throw Error("Signature not valid hex (0x…) ");s(""),h(!1),console.log("[compose] build+sign ms",Math.round(performance.now()-l)),(async()=>{let t=performance.now();try{let r="web3"===x.kind?{"x-posting-kind":"web3","x-posting-parent":x.parent,"x-posting-key":x.safe,"x-posting-auth":"parent-bound"}:void 0,a=await y({payload:p,signature:v,signatureType:"eip191"},r);console.log("[compose] /api/forum/post ms",Math.round(performance.now()-t)),null==o||o({...a,clientTag:e})}catch(r){console.log("[compose] /api/forum/post FAILED ms",Math.round(performance.now()-t));let e=r instanceof Error?r.message:String(r);m(e)}})()}catch(e){h(!1),m(e instanceof Error?e.message:String(e))}}return(0,a.jsxs)("div",{className:"rounded border p-3 bg-white/90 space-y-2",children:[(0,a.jsx)("div",{className:"text-sm font-semibold",children:r?"Reply":"Start a thread"}),(0,a.jsx)("textarea",{value:i,onChange:e=>s(e.target.value),placeholder:r?"Write a reply…":"Write a new thread…",className:"w-full min-h-[90px] rounded border p-2"}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(d.$,{onClick:b,disabled:f||!i.trim()||"web3"===x.kind&&"parent-bound"!==x.postAuth,children:f?"Posting…":"Post"}),p&&(0,a.jsx)("span",{className:"text-xs text-red-600",children:p})]})]})}var j=r(5239),S=r(73),N=r(6329);function E(e){let{boardId:t,threadRef:r}=e,[n,o]=(0,l.useState)(null);return((0,l.useEffect)(()=>{if(!r||!function(e){let t=(null==e?void 0:e.startsWith("0x"))?e.slice(2):e;return/^[0-9a-fA-F]{64}$/.test(t)}(r))return void o(0);let e=new AbortController;return(async()=>{try{let a=(0,N.apiUrl)("/api/forum/thread?boardId=".concat(encodeURIComponent(t),"&threadRef=").concat(encodeURIComponent(r),"&summary=1&limit=1")),n=await fetch(a,{signal:e.signal});if(!n.ok)return void o(0);let l=await n.json().catch(()=>({})),i="number"==typeof l.total&&l.total||"number"==typeof l.count&&l.count||Array.isArray(l.posts)&&l.posts.length||0;o(i)}catch(e){o(0)}})(),()=>e.abort()},[t,r]),n)?(0,a.jsxs)("span",{className:"inline-flex items-center text-[11px] px-2 py-0.5 rounded bg-gray-100 border",children:[n," ",1===n?"reply":"replies"]}):null}var k=r(3807);function A(e){let{boardId:t,refHex:r,kind:n,onMuted:o}=e,{isAdmin:i,address:s}=(0,k.y)(),[c,d]=(0,l.useState)(!1);if(!i)return null;async function u(e){if(e.preventDefault(),e.stopPropagation(),!c){d(!0);try{let e=await fetch((0,N.apiUrl)("/api/moderation/mute"),{method:"POST",credentials:"include",cache:"no-store",headers:{"Content-Type":"application/json",...s?{"X-Subject-Address":s}:{}},body:JSON.stringify({boardId:t,ref:r,kind:n})}),a=await e.json().catch(()=>({}));if(!e.ok||(null==a?void 0:a.ok)===!1)throw Error((null==a?void 0:a.error)||"HTTP ".concat(e.status));null==o||o(),window.dispatchEvent(new Event("moderation:changed"))}catch(e){console.error("Mute failed:",e),alert("Mute failed: ".concat(e instanceof Error?e.message:"Unknown error"))}finally{d(!1)}}}return(0,a.jsx)("button",{onClick:u,disabled:c,className:"text-xs opacity-70 hover:opacity-100 underline underline-offset-2 disabled:opacity-40",title:"Hide this ".concat(n," for everyone (admin)"),children:c?"Muting…":"Mute"})}function R(e){return new Promise((t,r)=>{let a=new window.Image;a.onload=()=>{var e;let r=null==(e=a.decode)?void 0:e.call(a);r&&"function"==typeof r.then?r.then(()=>t()).catch(()=>t()):t()},a.onerror=()=>r(Error("img error")),a.src=e})}function C(e){let{refHex:t,author:r,displayName:n,avatarRef:o,content:i,createdAt:s,currentAvatarRef:c=null,boardId:d,threadRef:u,isRoot:f=!1,onMutedThread:h,onMutedReply:p}=e,m=(0,l.useMemo)(()=>{var e;return null!=(e=(0,S.YT)(o))?e:(0,S.YT)(c)},[o,c]),[w,x]=(0,l.useState)(m),[y,v]=(0,l.useState)(""),[g,b]=(0,l.useState)(!1),k=(0,l.useRef)(!1),C=(0,l.useRef)(!0);(0,l.useEffect)(()=>(C.current=!0,()=>{C.current=!1}),[]),(0,l.useEffect)(()=>{b(!1),k.current=!0,(async()=>{try{if(m){let e=(0,N.apiUrl)("/api/swarm/img/".concat(m));if(await R(e).then(()=>!0).catch(()=>!1)&&C.current){x(m),v(""),b(!0),k.current=!1;return}}let e=(0,S.YT)(await (0,S.yU)(r));if(!e||!C.current){C.current&&(x(null),b(!1));return}let t=(0,N.apiUrl)("/api/swarm/img/".concat(e,"?v=").concat(Date.now()));await R(t).then(()=>!0).catch(()=>!1)&&C.current?(v(String(Date.now())),x(e),b(!0)):C.current&&(x(null),b(!1))}catch(e){C.current&&(x(null),b(!1))}finally{k.current=!1}})()},[m,r]);let P=w?(0,N.apiUrl)("/api/swarm/img/".concat(w).concat(y?"?v=".concat(y):"")):null;return(0,a.jsxs)("div",{className:"rounded border p-3 bg-white/90 flex gap-3",children:[(0,a.jsxs)("div",{className:"relative w-11 h-11",children:[(0,a.jsx)("div",{className:"absolute inset-0 rounded-full bg-gray-200 border"}),P&&(0,a.jsx)(j.default,{src:P,alt:"avatar",fill:!0,sizes:"44px",unoptimized:!0,loading:"eager",priority:!0,className:"rounded-full object-cover border transition-opacity duration-150 ".concat(g?"opacity-100":"opacity-0"),onError:()=>{k.current||(k.current=!0,b(!1),(async()=>{try{let e=(0,S.YT)(await (0,S.yU)(r));if(!e||e===w||!C.current){x(null),b(!0),k.current=!1;return}let t=(0,N.apiUrl)("/api/swarm/img/".concat(e,"?v=").concat(Date.now()));if(await R(t).catch(()=>{C.current&&(x(null),b(!0))}),!C.current)return;v(String(Date.now())),x(e),b(!0)}catch(e){C.current&&(x(null),b(!0))}finally{k.current=!1}})())},onLoad:()=>b(!0),draggable:!1})]}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:"text-sm font-semibold",children:null!=n?n:"(anon)"}),(0,a.jsxs)("div",{className:"text-[11px] text-gray-500 break-all",children:["\xb7 ",r]}),(0,a.jsx)("div",{className:"ml-auto text-[11px] text-gray-400",children:s?new Date(s).toLocaleString():""})]}),(0,a.jsx)("div",{className:"text-sm whitespace-pre-wrap mt-1",children:i}),(0,a.jsxs)("div",{className:"text-[10px] text-gray-400 break-all mt-2",children:["ref: ",t]}),f&&d&&u&&(0,a.jsxs)("div",{className:"mt-2",children:[(0,a.jsx)(E,{boardId:d,threadRef:u}),(0,a.jsx)(A,{boardId:d,refHex:t,kind:"thread",onMuted:h})]}),!f&&d&&(0,a.jsx)("div",{className:"mt-2",children:(0,a.jsx)(A,{boardId:d,refHex:t,kind:"reply",onMuted:p})})]})]})}function P(){let[e,t]=(0,l.useState)(!1),[r,n]=(0,l.useState)(null),o=(0,c.A)();async function i(){n(null),t(!0);try{let e="web3"===o.kind?o.parent:"local"===o.kind?o.safe:null;if(!e)throw Error("Not logged in");let t=await fetch((0,N.apiUrl)("/api/auth/admin/elevate"),{method:"POST",credentials:"include",headers:{"X-Subject-Address":e}}),r=await t.json().catch(()=>({}));if(!t.ok||!(null==r?void 0:r.ok))throw Error((null==r?void 0:r.error)||"Elevate failed (HTTP ".concat(t.status,")"));window.dispatchEvent(new Event("admin:changed"))}catch(e){n(e instanceof Error?e.message:"Moderator sign-in failed")}finally{t(!1)}}return(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("button",{onClick:i,disabled:e,className:"px-3 py-1.5 text-sm rounded border bg-black text-white disabled:opacity-60",children:e?"Authorizing…":"Moderator sign-in"}),r&&(0,a.jsx)("span",{className:"text-xs text-red-600",children:r})]})}function T(){async function e(){await fetch((0,N.apiUrl)("/api/auth/logout"),{method:"POST",credentials:"include"}),window.dispatchEvent(new Event("admin:changed"))}return(0,a.jsx)("button",{onClick:e,className:"px-3 py-1.5 text-sm rounded border",children:"Sign out"})}function I(){var e,t;let r=(0,i.useRouter)(),n=(null==(e=(0,i.useSearchParams)().get("thread"))?void 0:e.toLowerCase())||null,{profile:c}=(0,v.x)(),d=null==c||null==(t=c.subject)?void 0:t.toLowerCase(),{isAdmin:u}=(0,k.y)(),[f,w]=(0,l.useState)([]),[x,y]=(0,l.useState)({}),[g,j]=(0,l.useState)(!1),[E,A]=(0,l.useState)(null),R=!!n;return(0,l.useEffect)(()=>{let e=!1;return(async()=>{j(!0),A(null);try{if(n){let t=await p(s,n);if(e)return;let r=await fetch((0,N.apiUrl)("/api/moderation/muted?boardId=".concat(encodeURIComponent(s),"&kind=reply")),{cache:"no-store"}).then(e=>e.json()).catch(()=>({refs:[]})),a=new Set(Array.isArray(r.refs)?r.refs.map(e=>e.toLowerCase()):[]),o=t.posts.filter(e=>!a.has(e.toLowerCase()));w(o);let l={};for(let t of o){try{l[t]=await m(t)}catch(e){l[t]=null}if(e)return}y(l)}else{let t=await h(s);if(e)return;let r=await fetch((0,N.apiUrl)("/api/moderation/muted?boardId=".concat(encodeURIComponent(s),"&kind=thread")),{cache:"no-store"}).then(e=>e.json()).catch(()=>({refs:[]})),a=new Set(Array.isArray(r.refs)?r.refs.map(e=>e.toLowerCase()):[]),n=t.threads.filter(e=>!a.has(e.toLowerCase()));w(n);let o={};for(let t of n){try{o[t]=await m(t)}catch(e){o[t]=null}if(e)return}y(o)}}catch(t){e||A(t instanceof Error?t.message:"Failed to load")}finally{e||j(!1)}})(),()=>{e=!0}},[n]),(0,l.useEffect)(()=>{let e=Array.from(new Set(Object.values(x).map(e=>{var t,r;return null==e||null==(r=e.payload)||null==(t=r.subject)?void 0:t.toLowerCase()}).filter(Boolean)));(0,S.FQ)(e.slice(0,12))},[x]),(0,a.jsxs)("main",{className:"mx-auto max-w-3xl px-4 py-4 space-y-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("button",{onClick:()=>r.push(R?"/forum":"/dashboard"),className:"text-sm text-gray-600 hover:text-gray-900 underline",children:R?"Back":"Back to Dashboard"}),(0,a.jsx)("h1",{className:"text-lg font-semibold",children:R?"Thread":"Forum — ".concat(s)})]}),(0,a.jsx)("div",{className:"flex items-center gap-2",children:u?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("span",{className:"text-xs rounded bg-gray-200 px-2 py-1",children:"Admin mode"}),(0,a.jsx)(T,{})]}):(0,a.jsx)(P,{})})]}),(0,a.jsx)(b,{boardId:s,replyTo:R?n:void 0,onOptimistic:e=>{let{threadRef:t,postRef:r,payload:a}=e,n=R?r:t;n&&(w(e=>[n,...e]),y(e=>({...e,[n]:{payload:a}})))},onPosted:e=>{let t=R?e.postRef:e.threadRef,r=e.clientTag?"local:".concat(e.clientTag):null;w(e=>[t,...e.filter(e=>e!==t&&e!==r)]),m(t).then(e=>{y(a=>{let n={...a};return r&&delete n[r],n[t]=e,n})}).catch(()=>{r&&y(e=>{let t={...e};return delete t[r],t})})}}),(0,a.jsxs)("section",{className:"space-y-3",children:[g&&(0,a.jsx)("div",{className:"text-sm text-gray-500",children:"Loading board…"}),E&&(0,a.jsx)("div",{className:"text-sm text-red-600",children:E}),!g&&!E&&0===f.length&&(0,a.jsx)("div",{className:"text-sm text-gray-500",children:"No threads yet. Start one!"}),f.map(e=>{var t,r,l,i,u,f;let h=x[e],p=(null!=(t=null==h?void 0:h.payload.subject)?t:"").toLowerCase(),m=(0,a.jsx)(C,{refHex:e,author:null!=(r=null==h?void 0:h.payload.subject)?r:"(unknown)",displayName:null==h?void 0:h.payload.displayName,avatarRef:null!=(l=(0,S.cX)(null==h?void 0:h.payload))?l:void 0,currentAvatarRef:p&&d&&p===d&&null!=(i=(0,S.F1)(c))?i:null,content:null!=(u=null==h?void 0:h.payload.content)?u:"(no content)",createdAt:null!=(f=null==h?void 0:h.payload.createdAt)?f:0,boardId:s,threadRef:R?n:e,isRoot:!R,onMutedThread:R?void 0:()=>{w(t=>t.filter(t=>t!==e)),y(t=>{let r={...t};return delete r[e],r})}},e);return R?m:(0,a.jsx)(o(),{href:"/forum?thread=".concat(e),className:"block hover:opacity-90 transition",children:m},e)})]})]})}function O(){return(0,a.jsx)(l.Suspense,{fallback:(0,a.jsx)("div",{className:"p-4 text-center",children:"Loading..."}),children:(0,a.jsx)(I,{})})}}},e=>{e.O(0,[993,149,239,619,452,526,441,493,358],()=>e(e.s=431)),_N_E=e.O()}]);