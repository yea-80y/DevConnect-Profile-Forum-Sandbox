(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[636],{1312:(e,t,a)=>{"use strict";a.d(t,{A:()=>c});var r=a(5155),l=a(5239),n=a(2115),o=a(43),s=a(8701);function c(e){var t,a,c;let{subject:i,feedOwner:d}=e,{profile:u,ensureFresh:f}=(0,o.x)(),m=(0,n.useRef)(f);(0,n.useEffect)(()=>{m.current=f},[f]);let v=(0,n.useRef)(null==u?void 0:u.avatarMarker),[x,p]=(0,n.useState)(!1);(0,n.useEffect)(()=>{p(!1)},[null==u?void 0:u.avatarRef,null==u?void 0:u.avatarMarker]);let w=(0,n.useRef)(null),h=(0,n.useRef)(!1),g=(0,n.useRef)(0);(0,n.useEffect)(()=>{let e="".concat(null!=i?i:"nosub","|").concat(null!=d?d:"noown");if(w.current===e||(w.current=e,v.current))return;let t=Date.now();if(t-g.current<1e3||(g.current=t,h.current))return;h.current=!0;let a=setTimeout(async()=>{try{await m.current()}finally{h.current=!1}},250);return()=>clearTimeout(a)},[i,d]);let b=null!=(t=null==u?void 0:u.name)?t:null,j=null!=(a=null==u?void 0:u.avatarRef)?a:null,y=j?j.toLowerCase().replace(/\/+$/,""):null,N=(0,n.useMemo)(()=>{if(!y)return null;let e=(null==u?void 0:u.avatarMarker)?"?v=".concat(u.avatarMarker):"";return"".concat(s.b,"/bzz/").concat(y).concat(e)},[y,null==u?void 0:u.avatarMarker]);return console.log("[ProfileView] avatarRef =",j,"→ avatarSrc =",N),(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[N&&!x?(0,r.jsx)(l.default,{src:N,alt:"avatar",width:80,height:80,unoptimized:!0,className:"w-20 h-20 rounded-full object-cover border",onError:()=>p(!0)},"".concat(y,"-").concat(null!=(c=null==u?void 0:u.avatarMarker)?c:"0")):(0,r.jsx)("div",{className:"w-20 h-20 rounded-full bg-gray-200 border"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-lg font-semibold",children:null!=b?b:"(no name yet)"}),(0,r.jsx)("div",{className:"text-xs text-gray-500 break-all",children:i}),d&&(0,r.jsxs)("div",{className:"text-[10px] text-gray-400 break-all",children:["owner: ",d]})]})]})}},3607:(e,t,a)=>{Promise.resolve().then(a.bind(a,5946))},5946:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>g});var r=a(5155),l=a(2115),n=a(2619),o=a.n(n),s=a(43),c=a(8701),i=a(2983),d=a(6149),u=a(5239),f=a(1312);let m=l.forwardRef((e,t)=>{let{className:a,...l}=e;return(0,r.jsx)("input",{ref:t,suppressHydrationWarning:!0,className:"w-full rounded-lg border px-3 py-2 outline-none focus:ring-2 focus:ring-black/10 ".concat(null!=a?a:""),...l})});m.displayName="Input";var v=a(3998),x=a(5373),p=a(6329);async function w(e){let t=await fetch((0,p.apiUrl)("/api/profile"),{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw Error(await t.text().catch(()=>"")||"POST /api/profile failed: ".concat(t.status));let a=await t.json();if(!a.ok||!a.owner||!a.owner.startsWith("0x"))throw Error("Server did not return a valid owner address");return{ok:!0,owner:a.owner}}function h(){let e=(0,l.useMemo)(()=>new d.VL(c.b),[]),{applyLocalUpdate:t,ensureFresh:a}=(0,s.x)(),[n,o]=(0,l.useState)(""),p=(0,l.useRef)(null),[h,g]=(0,l.useState)(null),[b,j]=(0,l.useState)(!1),[y,N]=(0,l.useState)(!1),[S,E]=(0,l.useState)(null),[k,R]=(0,l.useState)(0),[O,C]=(0,l.useState)(null);(0,l.useEffect)(()=>{try{let e=localStorage.getItem("woco.owner0x");e&&e.startsWith("0x")&&C(e)}catch(e){}},[]),(0,l.useEffect)(()=>{let e=()=>R(e=>e+1);return window.addEventListener("profile:updated",e),()=>window.removeEventListener("profile:updated",e)},[]);let I=(0,i.A)(),A=(0,l.useMemo)(()=>{if(!(null==I?void 0:I.ready))return null;let e="web3"===I.kind?I.parent:"local"===I.kind?I.safe:void 0;return e&&/^0x[0-9a-fA-F]{40}$/.test(e)?e:null},[null==I?void 0:I.ready,null==I?void 0:I.kind,null==I?void 0:I.parent,null==I?void 0:I.safe]);async function L(r){r.preventDefault(),E(null),N(!1),j(!0);try{var l,o,s;if(!c.r)throw Error("Set NEXT_PUBLIC_POSTAGE_BATCH_ID in .env.local");if(!A)throw Error("No active account – create/select one on the Accounts/Home screen first.");let r=A.slice(2).toLowerCase(),i=n.trim();if(i){let{owner:e}=await w({kind:"name",payload:{name:i,subject:A}});C(e);try{localStorage.setItem("woco.owner0x",e)}catch(e){}t({name:i});try{let e="woco.profile.".concat(A.toLowerCase()),t=JSON.parse(localStorage.getItem(e)||"{}");localStorage.setItem(e,JSON.stringify({...t,name:i,updatedAt:Date.now()}))}catch(e){}window.dispatchEvent(new Event("profile:updated")),setTimeout(()=>{a()},1200),setTimeout(()=>{a()},3e3);let l="".concat(x.l4,"/name/").concat(r),n=d.KK.fromString(l).toString();console.log("[profile] name saved via platform signer",{feedOwner0x:e,subject0x:A,topicStr:l,topicHex:n,feedGET:"".concat(c.b,"/feeds/").concat(e,"/").concat(n)})}let u=null!=(s=null==(o=p.current)||null==(l=o.files)?void 0:l[0])?s:null;if(u){let l=(await e.uploadFile(c.r,u,u.name)).reference.toHex(),n=function(e){if(!e)throw Error("missing ref");let t=e.toLowerCase().replace(/^0x/,"").replace(/[^0-9a-f]/g,"");if(64!==t.length)throw Error("bad ref length: ".concat(t.length));return t}(l);console.log("[profile] avatar uploaded (immutable BZZ)",{imageRefHex:n,bzz:"".concat(c.b,"/bzz/").concat(n)});let{owner:o}=await w({kind:"avatar",payload:{imageRef:n,subject:A}});C(o);try{localStorage.setItem("woco.owner0x",o)}catch(e){}t({avatarRef:n,avatarMarker:Date.now().toString(16)}),g(null),p.current&&(p.current.value="");try{let e="woco.profile.".concat(A.toLowerCase()),t=JSON.parse(localStorage.getItem(e)||"{}");localStorage.setItem(e,JSON.stringify({...t,avatarRef:n,updatedAt:Date.now()}))}catch(e){}window.dispatchEvent(new Event("profile:updated")),setTimeout(()=>{a()},1200),setTimeout(()=>{a()},3e3);let s="".concat(x.l4,"/avatar/").concat(r),i=d.KK.fromString(s).toString();console.log("[profile] avatar feed updated via platform signer",{feedOwner0x:o,subject0x:A,topicStr:s,topicHex:i,feedGET:"".concat(c.b,"/feeds/").concat(o,"/").concat(i)})}N(!0)}catch(e){E(e instanceof Error?e.message:String(e))}finally{j(!1)}}return(0,l.useEffect)(()=>{if(null==I?void 0:I.ready)try{A?localStorage.setItem("woco.subject0x",A):localStorage.removeItem("woco.subject0x"),window.dispatchEvent(new Event("account:changed"))}catch(e){}},[null==I?void 0:I.ready,A]),(0,r.jsxs)("div",{className:"w-full max-w-2xl mx-auto p-4 space-y-6",children:[(0,r.jsxs)("div",{className:"rounded border p-4 bg-white/80",children:[(0,r.jsx)("div",{className:"font-semibold mb-2",children:"Create / Update Profile (platform signer → per-user topics)"}),(0,r.jsxs)("form",{onSubmit:L,className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm mb-1",children:"Display name"}),(0,r.jsx)(m,{value:n,onChange:e=>o(e.target.value),placeholder:"e.g. Nickname"})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("label",{className:"block text-sm",children:"Avatar (optional)"}),(0,r.jsx)("input",{ref:p,type:"file",accept:"image/*",onChange:function(e){var t,a;let r=null!=(a=null==(t=e.target.files)?void 0:t[0])?a:null;if(!r)return void g(null);g(URL.createObjectURL(r))},className:"block w-full text-sm"}),h&&(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)(u.default,{src:h,alt:"preview",width:64,height:64,className:"w-16 h-16 rounded-full object-cover border"}),(0,r.jsx)("div",{className:"text-xs text-gray-500",children:"Preview"})]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(v.$,{type:"submit",disabled:b||!A,children:b?"Saving…":"Save"}),y&&(0,r.jsx)("span",{className:"text-green-600 text-sm",children:"Saved ✔"}),S&&(0,r.jsxs)("span",{className:"text-red-600 text-sm",children:["Error: ",S]})]}),!(null==I?void 0:I.ready)&&(0,r.jsx)("div",{className:"text-sm text-gray-500",children:"Checking your account…"}),(null==I?void 0:I.ready)&&!A&&(0,r.jsxs)("div",{className:"mb-3 rounded-md border border-amber-300 bg-amber-50 text-amber-800 p-3 text-sm",children:["No active account. Please"," ",(0,r.jsx)("a",{href:"/accounts",className:"underline",children:"open Accounts"})," ","to sign in (Web3) or create a local account."]})]})]}),(0,r.jsxs)("div",{className:"rounded border p-4 bg-white/80",children:[(0,r.jsx)("div",{className:"font-semibold mb-2",children:"Current Profile (in-state)"}),O&&A?(0,r.jsx)(f.A,{subject:A,feedOwner:O},"".concat(A,"|").concat(k)):(0,r.jsx)("p",{className:"text-sm text-gray-500",children:"Save first (needs platform feed owner and an active user account)."})]}),(0,r.jsxs)("p",{className:"text-xs text-gray-500",children:["Bee: ",c.b," • Batch: ",null===c.r||void 0===c.r?void 0:c.r.slice(0,10),"…"]})]})}function g(){let e=(0,i.A)(),t=(0,l.useMemo)(()=>{if(!(null==e?void 0:e.ready))return null;let t="web3"===e.kind?e.parent:"local"===e.kind?e.safe:void 0;return t&&/^0x[0-9a-fA-F]{40}$/.test(t)?t:null},[null==e?void 0:e.ready,null==e?void 0:e.kind,null==e?void 0:e.parent,null==e?void 0:e.safe]),[a,n]=(0,l.useState)(null);return(0,l.useEffect)(()=>{try{let e=localStorage.getItem("woco.owner0x");e&&e.startsWith("0x")&&n(e)}catch(e){}let e=()=>{try{let e=localStorage.getItem("woco.owner0x");n(e&&e.startsWith("0x")?e:null)}catch(e){}};return window.addEventListener("profile:updated",e),()=>window.removeEventListener("profile:updated",e)},[]),(0,r.jsxs)("main",{className:"p-4",children:[(0,r.jsx)("div",{className:"mb-3",children:(0,r.jsx)(o(),{href:"/",className:"inline-flex items-center px-3 py-1.5 text-sm rounded border bg-white",children:"← Home"})}),(0,r.jsx)(s.H,{beeUrl:c.b,subject:t,feedOwner:a,children:(0,r.jsx)(h,{})})]})}}},e=>{e.O(0,[993,149,239,619,452,526,441,493,358],()=>e(e.s=3607)),_N_E=e.O()}]);