"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[452],{2983:(e,t,a)=>{a.d(t,{A:()=>J});var r=a(2115),o=a(9550),n=a(9353),s=a(9915),c=a(5729),i=a(8879),u=a(2507),l=a(6993);async function d(e){let t=await e.request({method:"eth_requestAccounts"});if(!(null==t?void 0:t.length))throw Error("No accounts authorized");let a="string"==typeof e.selectedAddress?e.selectedAddress:void 0,r=t.map(e=>e.toLowerCase()),n=a&&r.includes(a.toLowerCase())?a:t[0];return(0,o.b)(n)}function w(){return{nonce:"function"==typeof crypto.randomUUID?crypto.randomUUID():function(){let e=new Uint8Array(16);crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;let t=Array.from(e,e=>e.toString(16).padStart(2,"0"));return"".concat(t.slice(0,4).join(""),"-").concat(t.slice(4,6).join(""),"-").concat(t.slice(6,8).join(""),"-").concat(t.slice(8,10).join(""),"-").concat(t.slice(10).join(""))}(),issuedAt:new Date().toISOString()}}function f(){return window.location?window.location.host:""}function p(e){try{document.cookie="woco_subject0x=".concat(e,"; Path=/; Max-Age=").concat(2592e3,"; SameSite=Lax")}catch(e){}}let y={name:"WoCo Capability",version:"1"},m={AuthorizeSafeSigner:[{name:"host",type:"string"},{name:"parent",type:"address"},{name:"safe",type:"address"},{name:"purpose",type:"string"},{name:"nonce",type:"string"},{name:"issuedAt",type:"string"},{name:"expiresAt",type:"string"},{name:"safeProof",type:"bytes"},{name:"clientCodeHash",type:"bytes32"},{name:"statement",type:"string"}]},g={...m,EIP712Domain:[{name:"name",type:"string"},{name:"version",type:"string"}]},h="forum-posting",b="woco:deviceKey",S="woco:encKeystore",v="woco:encCap",k="woco:kind";function C(){return new Promise((e,t)=>{let a=indexedDB.open("woco-auth",1);a.onupgradeneeded=()=>{a.result.objectStoreNames.contains("kv")||a.result.createObjectStore("kv")},a.onsuccess=()=>e(a.result),a.onerror=()=>{var e;return t(null!=(e=a.error)?e:Error("IndexedDB open error"))}})}async function x(e,t){let a=await C();await new Promise((r,o)=>{let n=a.transaction("kv","readwrite");n.objectStore("kv").put(t,e),n.oncomplete=()=>r(),n.onerror=()=>{var e;return o(null!=(e=n.error)?e:Error("IDB put error"))}})}async function A(e){let t=await C();return await new Promise((a,r)=>{let o=t.transaction("kv","readonly").objectStore("kv").get(e);o.onsuccess=()=>a(o.result),o.onerror=()=>{var e;return r(null!=(e=o.error)?e:Error("IDB get error"))}})}async function E(e){let t=await C();await new Promise((a,r)=>{let o=t.transaction("kv","readwrite");o.objectStore("kv").delete(e),o.oncomplete=()=>a(),o.onerror=()=>{var e;return r(null!=(e=o.error)?e:Error("IDB delete error"))}})}function I(e){let t=new ArrayBuffer(e.byteLength);return new Uint8Array(t).set(e),t}async function j(){let e=await A(b);if(e)return e;let t=await crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return await x(b,t),t}function D(e){let t=e.startsWith("0x")?e.slice(2):e,a=new Uint8Array(t.length/2);for(let e=0;e<a.length;e++)a[e]=parseInt(t.slice(2*e,2*e+2),16);return a}function L(e){return"0x"+Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("")}async function P(e,t){let a=new Uint8Array(12);crypto.getRandomValues(a);let r=I(a),o=I(new TextEncoder().encode(JSON.stringify(t))),n=await crypto.subtle.encrypt({name:"AES-GCM",iv:r},e,o);return{iv:L(a),ct:L(new Uint8Array(n))}}async function N(e,t){let a=D(t.iv),r=D(t.ct),o=I(a),n=I(r),s=await crypto.subtle.decrypt({name:"AES-GCM",iv:o},e,n);return JSON.parse(new TextDecoder().decode(s))}function O(e){var t,a,r;return{host:e.host,parent:(0,o.b)(e.parent),safe:(0,o.b)(e.safe),purpose:null!=(t=e.purpose)?t:h,nonce:e.nonce,issuedAt:e.issuedAt,expiresAt:e.expiresAt,safeProof:e.safeProof,clientCodeHash:null!=(a=e.clientCodeHash)?a:n.p,statement:null!=(r=e.statement)?r:"Authorize ".concat(e.safe," for posting at ").concat(e.host)}}async function M(e,t,a){let r=JSON.stringify(a);return console.debug("[712] request v4 once"),await e.request({method:"eth_signTypedData_v4",params:[t,r]})}function U(e){let t="message"in e?JSON.stringify(e.message):JSON.stringify(e);return(0,s.S)((0,c.YW)(t))}function _(e,t,a){try{let r,o,n=e.message,s=Date.now();if(!(new Date(n.expiresAt).getTime()>s))return console.debug("[cap][fail] expiry",{expiresAt:n.expiresAt,nowISO:new Date(s).toISOString()}),!1;if(n.host!==a)return console.debug("[cap][fail] host",{capHost:n.host,expectedHost:a}),!1;if(n.safe.toLowerCase()!==t.toLowerCase())return console.debug("[cap][fail] safe",{capSafe:n.safe,expectedSafe:t}),!1;let c="".concat(n.host,":").concat(n.nonce);try{r=(0,i.l)(c,n.safeProof)}catch(e){return console.debug("[cap][fail] safeProof:badSigFormat",e),!1}if(r.toLowerCase()!==n.safe.toLowerCase())return console.debug("[cap][fail] safeProof:mismatch",{recSafe:r,capSafe:n.safe,challenge:c}),!1;try{o=(0,u.w)(y,m,n,e.parentSig)}catch(e){return console.debug("[cap][fail] parentSig:bad712",e),!1}if(o.toLowerCase()!==n.parent.toLowerCase())return console.debug("[cap][fail] parentSig:mismatch",{recoveredParent:o,capParent:n.parent}),!1;if(n.purpose!==h)return console.debug("[cap][fail] purpose",{capPurpose:n.purpose,expected:h}),!1;return console.debug("[cap][ok]"),!0}catch(e){return console.debug("[cap][error] unexpected",e),!1}}function J(){let[e,t]=(0,r.useState)(!1),[a,n]=(0,r.useState)("none"),[s,c]=(0,r.useState)("blocked"),[i,h]=(0,r.useState)(void 0),[b,C]=(0,r.useState)(void 0),[I,D]=(0,r.useState)(void 0),L=(0,r.useRef)(null),J=(0,r.useRef)(null),R=(0,r.useRef)(!1);(0,r.useEffect)(()=>{(async()=>{try{let e=await A(k),a=await j(),r=await A(S),s=await A(v);if(!e||!r){n("none"),c("blocked"),t(!0);return}let{keystore:i}=await N(a,r),u=await l.u.fromEncryptedJson(i,"dummy-pass");if(L.current=u,C(u.address),"local"===e){n("local"),c("local-only");try{sessionStorage.setItem("woco.subject0x",u.address)}catch(e){}t(!0);return}if(!s){n("web3"),c("blocked"),t(!0);return}let{capability:d,parentSig:w}=await N(a,s),p={message:d,parentSig:w};n("web3");let y=_(p,u.address,f());if(D(U(p)),y){let e=(0,o.b)(p.message.parent);h(e),c("parent-bound");try{sessionStorage.setItem("woco.subject0x",e)}catch(e){}}else{h(void 0),c("blocked");try{sessionStorage.removeItem("woco.subject0x")}catch(e){}}t(!0)}catch(e){console.warn("rehydrate failed",e),n("none"),c("blocked"),t(!0)}})()},[]);let T=(0,r.useCallback)(async e=>{let t=L.current;if(!t)throw Error("Posting key not unlocked");let a="string"==typeof e?e:new TextDecoder().decode(e);return await t.signMessage(a)},[]),z=(0,r.useCallback)(async()=>{let e=await j(),a=l.u.createRandom(),r=await a.encrypt("dummy-pass"),o=await P(e,{keystore:r});await x(S,o),await x(k,"local"),L.current=a,C(a.address);try{sessionStorage.setItem("woco.subject0x",a.address)}catch(e){}return n("local"),h(void 0),D(void 0),c("local-only"),t(!0),!0},[]),B=(0,r.useCallback)(async()=>{if(R.current)return!1;R.current=!0;try{let e=await j(),a=await A(S),r=await A(v),s=await A(k);if("web3"===s&&a&&r){let{keystore:s}=await N(e,a),i=await l.u.fromEncryptedJson(s,"dummy-pass"),{capability:u,parentSig:d}=await N(e,r),w={message:u,parentSig:d};if(_(w,i.address,f())){L.current=i;let e=(0,o.b)(w.message.parent);C(i.address),h(e),D(U(w)),n("web3"),c("parent-bound"),t(!0),p(e);try{sessionStorage.setItem("woco.subject0x",e)}catch(e){}return R.current=!1,!0}}}catch(e){}let e=!1;try{let a=window.ethereum;if(!a)throw Error("No wallet found");let r=await d(a),o=l.u.createRandom(),{nonce:s,issuedAt:i}=w(),b=f(),A=new Date(Date.now()+31536e6).toISOString(),E=await o.signMessage("".concat(b,":").concat(s)),I=O({host:b,parent:r,safe:o.address,nonce:s,issuedAt:i,expiresAt:A,safeProof:E,statement:"Authorize ".concat(o.address," as posting key for ").concat(b)}),N=await M(a,r,{domain:y,types:g,primaryType:"AuthorizeSafeSigner",message:I}),J=(0,u.w)(y,m,I,N);if(J.toLowerCase()!==r.toLowerCase())throw Error("712 mismatch: recovered ".concat(J," vs selected ").concat(r));let R={message:I,parentSig:N},T=await j(),z=await o.encrypt("dummy-pass"),B=await P(T,{keystore:z}),W=await P(T,{capability:R.message,parentSig:R.parentSig});await x(S,B),await x(v,W),await x(k,"web3"),L.current=o,C(o.address),h(r);try{sessionStorage.setItem("woco.subject0x",r)}catch(e){}D(U(R));let q=_(R,o.address,f());if(q){p(r);try{sessionStorage.setItem("woco.subject0x",r)}catch(e){}}console.debug("[login] verify result",{ok:q,hostSigned:I.host,hostVerify:f(),safe:o.address,parent:r}),n("web3"),c(q?"parent-bound":"blocked"),t(!0),e=q}catch(t){e=!1}finally{R.current=!1}return e},[]),W=(0,r.useCallback)(async()=>{if("web3"===a&&"parent-bound"!==s&&!R.current){R.current=!0;try{let e=window.ethereum;if(!e)throw Error("No wallet found");let t=await d(e),a=L.current;if(!a){let e=await j(),t=await A(S);if(!t)throw Error("Posting key not found. Please login again.");let{keystore:r}=await N(e,t);L.current=a=await l.u.fromEncryptedJson(r,"dummy-pass"),C(a.address)}let{nonce:r,issuedAt:o}=w(),n=f(),s=new Date(Date.now()+31536e6).toISOString(),i=await a.signMessage("".concat(n,":").concat(r)),b=O({host:n,parent:t,safe:a.address,nonce:r,issuedAt:o,expiresAt:s,safeProof:i}),E=await M(e,t,{domain:y,types:g,primaryType:"AuthorizeSafeSigner",message:b});console.debug("[712][startWeb3Login] verify check",{recovered:(0,u.w)(y,m,b,E),selected:t,hostSigned:b.host,hostNow:f()});let I=(0,u.w)(y,m,b,E);if(I.toLowerCase()!==t.toLowerCase())throw Error("712 mismatch: recovered ".concat(I," vs selected ").concat(t));let J={message:b,parentSig:E},R=await j(),T=await a.encrypt("dummy-pass"),z=await P(R,{keystore:T}),B=await P(R,{capability:J.message,parentSig:J.parentSig});await x(S,z),await x(v,B),await x(k,"web3"),L.current=a,C(a.address),h(t);try{sessionStorage.setItem("woco.subject0x",t)}catch(e){}D(U(J));let W=_(J,a.address,f());if(W){p(t);try{sessionStorage.setItem("woco.subject0x",t)}catch(e){}}c(W?"parent-bound":"blocked")}finally{R.current=!1}}},[a,s]),q=(0,r.useCallback)(async()=>{if("local"===a)return void await z();if("web3"===a){if(R.current)return;R.current=!0;try{let e=window.ethereum;if(!e)throw Error("No wallet found");let a=await d(e),r=l.u.createRandom(),{nonce:o,issuedAt:n}=w(),s=f(),i=new Date(Date.now()+31536e6).toISOString(),p=await r.signMessage("".concat(s,":").concat(o)),b=O({host:s,parent:a,safe:r.address,nonce:o,issuedAt:n,expiresAt:i,safeProof:p}),A=await M(e,a,{domain:y,types:g,primaryType:"AuthorizeSafeSigner",message:b});console.debug("[712][rotateSafe] verify check",{recovered:(0,u.w)(y,m,b,A),selected:a,hostSigned:b.host,hostNow:f()});let E=(0,u.w)(y,m,b,A);if(E.toLowerCase()!==a.toLowerCase())throw Error("712 mismatch: recovered ".concat(E," vs selected ").concat(a));let I={message:b,parentSig:A},N=await j(),J=await r.encrypt("dummy-pass"),R=await P(N,{keystore:J}),T=await P(N,{capability:I.message,parentSig:I.parentSig});await x(S,R),await x(v,T),await x(k,"web3"),L.current=r,C(r.address),h(a);try{sessionStorage.setItem("woco.subject0x",a)}catch(e){}D(U(I));let z=_(I,r.address,f());console.debug("[cap][rotateSafe] ok?",z),c(z?"parent-bound":"blocked"),t(!0)}finally{R.current=!1}}},[a,z]),H=(0,r.useCallback)(async()=>{await E(S),await E(v),await E(k);try{sessionStorage.removeItem("woco.subject0x")}catch(e){}try{document.cookie="woco_subject0x=; Path=/; Max-Age=0; SameSite=Lax"}catch(e){}L.current=null,n("none"),h(void 0),C(void 0),D(void 0),c("blocked"),t(!0)},[]);(0,r.useEffect)(()=>{"local"===a&&c("local-only")},[a]);let G=(0,r.useCallback)(e=>{J.current=e},[]);return(0,r.useEffect)(()=>{let e=function(e){if(!e)return;let t="function"==typeof e.on,a="function"==typeof e.off||"function"==typeof e.removeListener;return t&&a?e:void 0}(window.ethereum);if(null==e?void 0:e.on)return e.on("chainChanged",G),()=>{try{"function"==typeof e.off?e.off("chainChanged",G):"function"==typeof e.removeListener&&e.removeListener("chainChanged",G)}catch(e){}}},[G]),(0,r.useMemo)(()=>({ready:e,kind:a,postAuth:s,parent:i,safe:b,capId:I,startWeb3Login:B,startLocalLogin:z,signCapabilityNow:"web3"===a?W:void 0,rotateSafe:q,logout:H,signPost:T}),[e,a,s,i,b,I,B,z,W,q,H,T])}},6329:(e,t,a)=>{a.d(t,{apiUrl:()=>r});function r(e){let t=e.startsWith("/")?e:"/".concat(e);return"".concat("https://api.woco-net.com").concat(t)}}}]);